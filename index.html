<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.7.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":3,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Yasic Yu">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Yasic Yu">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Yasic Yu">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content=" ObjectiveC">
<meta property="article:tag" content=" Swift">
<meta property="article:tag" content=" XCode">
<meta property="article:tag" content=" Computer">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Yasic Yu</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-158916051-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-158916051-1');
      }
    </script>


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e11730c2477fa6748b6748c13059e7b1";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yasic Yu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">In Code We Trust</p>
  </div>

  <div class="site-nav-right"></div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">50</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/yasic" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/04/25/iOS%E5%BC%80%E5%8F%91/Swift%20%E4%B8%AD%E7%9A%84%20some%20%E5%92%8C%20any%20%E5%85%B3%E9%94%AE%E5%AD%97/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/25/iOS%E5%BC%80%E5%8F%91/Swift%20%E4%B8%AD%E7%9A%84%20some%20%E5%92%8C%20any%20%E5%85%B3%E9%94%AE%E5%AD%97/" class="post-title-link" itemprop="url">iOS开发/Swift 中的 some 和 any 关键字</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-25 22:04:09" itemprop="dateCreated datePublished" datetime="2023-04-25T22:04:09+08:00">2023-04-25</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>title: Swift 中的 some 和 any 关键字<br>date: 2023-04-26<br>category: iOS开发<br>description: “some 代表了不透明类型（opaque type），any 代表存在类型（existential type）”<br>tags:  [Swift]</p>
<hr>
<p>从定义出发，some 代表了不透明类型（opaque type），而 any 代表存在类型（existential type）。</p>
<p>如果用一句概括的话，some 代表存在某个具体类型，这个具体类型遵循了某种协议的约束，并且这个具体类型是可以在编译期确定的，而 any 代表任意一种满足某种协议约束的类型，但这个类型具体是什么，必须要在运行时才能确定。</p>
<h1 id="some-关键字"><a href="#some-关键字" class="headerlink" title="some 关键字"></a>some 关键字</h1><p>some 关键字是在 Swift 5.1 跟随 SwiftUI 的发布出现的，我们最常见到的 some 的使用如下所示</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> body: some <span class="type">View</span> &#123;</span><br><span class="line">    ···       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上在这里，some 主要起到的作用是为了减少类型定义的理解难度，body 内部可以返回任意一种 SwiftUI 定义的 View，但对外部调用者而言，其实并不关心 View 的具体类型，只要编译器确保返回值确实是 View 类型即可。因此 some View 就可以很好的表达这种 ”我不关心你是什么具体类型，只要编译器知道你的类型就可以” 的含义。</p>
<h2 id="Self-约束"><a href="#Self-约束" class="headerlink" title="Self 约束"></a>Self 约束</h2><p>让我们看一段代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Food</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Meat</span>: <span class="title">Food</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Unit</span> = <span class="type">Int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Vegetable</span>: <span class="title">Food</span> </span>&#123;</span><br><span class="line">    <span class="keyword">typealias</span> <span class="type">Unit</span> = <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: Food)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> m = food <span class="keyword">as</span>? <span class="type">Meat</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(m)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> v = food <span class="keyword">as</span>? <span class="type">Vegetable</span> &#123;</span><br><span class="line">            <span class="built_in">print</span>(v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        eat(<span class="type">Meat</span>())</span><br><span class="line">        eat(<span class="type">Vegetable</span>())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码可以编译通过，可以看到我们的 eat 函数接受一个 “Food 类型” 的参数，并在内部将其转化成不同类型的 Food，但实际上更确切的说这里接受的应该是遵循 Food 协议的类型，由于 Food 协议并没有特殊性，所以这样的代码目前是可以通过编译的。</p>
<p>但如果我们将 Food 修改为这样的实现</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Food</span>: <span class="title">Equatable</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们要求 Food 遵循 Equatable 协议，Equatable 协议的定义如下</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">protocol</span> <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> == <span class="params">(lhs: <span class="keyword">Self</span>, rhs: <span class="keyword">Self</span>)</span></span> -&gt; <span class="type">Bool</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它有一个静态方法需要传入类型为 Self 的参数，类似这种类型的函数参数，我们称为 <strong>Self 约束</strong>，针对这种情况，一开始定义的 eat 函数就会报错，原因是在缺乏额外信息的情况下，我们并不能确定出 food 的具体类型，如此一来，Equatable 要求的 Self 类型也无法推断出来。</p>
<p>可以想象一个简单的例子，如果我们在 eat 函数内部也有一个遵循 Food 类型的变量 a，那么变量 a 实际上是否能够和 food 参数判等是不能确定的，如果运行时传入的 food 和 a 的类型一样自然可以判等，但如果类型不一样就不能判等，我们就不能简单用一句 <code>a == food</code> 来实现我们的逻辑，这样 Equatable 协议就失去了它希望表达的两者可以判等的意图。</p>
<h2 id="关联类型"><a href="#关联类型" class="headerlink" title="关联类型"></a>关联类型</h2><p>接下来我们重新定义我们的 Food 协议</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Food</span>: <span class="title">Equatable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Unit</span>: <span class="type">Hashable</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们这里用到了关联类型，也就是 Unit，这样也会导致 eat 函数不能编译通过，原因和上面类似，因为有了关联类型 Unit 的存在，我们不能单纯从 Food 协议本身确定出具体类型，需要更多信息来确定。</p>
<h2 id="反向泛型"><a href="#反向泛型" class="headerlink" title="反向泛型"></a>反向泛型</h2><p>上面两种情况我们都可以用 some 关键字来解决编译问题，也就是类似下面这样</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: some Food)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> m = food <span class="keyword">as</span>? <span class="type">Meat</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> v = food <span class="keyword">as</span>? <span class="type">Vegetable</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它其实和用泛型约束实现是一个效果</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span>&lt;F: Food&gt;<span class="params">(<span class="number">_</span> food: F)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> m = food <span class="keyword">as</span>? <span class="type">Meat</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(m)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> v = food <span class="keyword">as</span>? <span class="type">Vegetable</span> &#123;</span><br><span class="line">        <span class="built_in">print</span>(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这两者又有所区别，让我们看看下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> -&gt; some <span class="type">Food</span> &#123;</span><br><span class="line">    <span class="type">Vegetable</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">b</span>&lt;F: Food&gt;<span class="params">()</span></span> -&gt; <span class="type">F</span> &#123;</span><br><span class="line">    <span class="type">F</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，函数 a 和 b 看起来实现了一样的效果，都是返回遵循 Food 协议的类型实例，但 b 函数返回的具体类型实际上取决于调用者，比如下面代码虽然都调用了 b 函数，但是返回值类型分别是 Vegetable 和 Meat。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> vegetable: <span class="type">Vegetable</span> = b()</span><br><span class="line"><span class="keyword">let</span> meat: <span class="type">Meat</span> = b()</span><br></pre></td></tr></table></figure>

<p>而 some 则不一样，无论是谁调用 a 函数，a 函数返回值类型都由 a 函数自身实现决定，在这里也就是 Vegetable 类型，这种由实现方决定具体返回类型的方式，又被称为“反向泛型”（reverse generics）。</p>
<h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>由于 some 关键字所解决的问题实际上是一种特定问题，所以大部分开发场景我们大概不会用到 some 关键字，我在这里总结了一些可能的使用场景</p>
<ul>
<li>如果一个泛型参数只在一个地方使用，可以用 some 代替它以提升代码可读性，类似前面的 eat 函数</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: some Food)</span></span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span>&lt;F: Food&gt;<span class="params">(<span class="number">_</span> food: F)</span></span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>作为模块的开发者，希望对外隐藏接口的返回值类型，例如上面所举的 a 函数</li>
</ul>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> -&gt; some <span class="type">Food</span> &#123;</span><br><span class="line">    <span class="type">Vegetable</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>类型过于复杂，并且对于开发者而言没有太大意义，只需要编译器知晓类型的信息即可</li>
</ul>
<p>例如，在 Combine 中，多个 Operator 叠加后的 Publisher 类型会非常复杂，而开发者并不需要关心具体类型，some 关键字就可以派上用场</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">somePublisher</span><span class="params">()</span></span> -&gt; some <span class="type">Publisher</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> p1 = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]]</span><br><span class="line">        .publisher</span><br><span class="line">        .flatMap &#123; $<span class="number">0</span>.publisher &#125;</span><br><span class="line">        .<span class="built_in">map</span> &#123; $<span class="number">0</span> * <span class="number">2</span> &#125;</span><br><span class="line">    <span class="keyword">return</span> p1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 p1 的类型为</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Publishers</span>.<span class="type">Map</span>&lt;<span class="type">Publishers</span>.<span class="type">FlatMap</span>&lt;<span class="type">Publishers</span>.<span class="type">Sequence</span>&lt;[<span class="type">Int</span>], <span class="type">Never</span>&gt;, <span class="type">Publishers</span>.<span class="type">Sequence</span>&lt;[[<span class="type">Int</span>]], <span class="type">Never</span>&gt;&gt;, <span class="type">Int</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="返回值一致性"><a href="#返回值一致性" class="headerlink" title="返回值一致性"></a>返回值一致性</h2><p>使用 some 关键字有一个需要注意的地方是，当作为返回值修饰词时，some 要求整个方法的返回值是唯一确定的类型，例如下面的代码就是不合法的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeCollection</span><span class="params">()</span></span> -&gt; some <span class="type">Collection</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="type">Int</span>.random(<span class="keyword">in</span>: <span class="number">0</span>...<span class="number">10</span>).isMultiple(of: <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="number">0</span>]</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">"0"</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体报错信息是</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function declares an opaque return type 'some Collection', but the return statements in its body do not have matching underlying types</span><br></pre></td></tr></table></figure>

<p>因为这个函数的返回值类型可能是 Int 数组也可能是字符串数组，这样编译阶段就无法确定 makeCollection 的返回值类型，换句话说，some 表达的是存在且只存在一种确定的类型，假如希望返回不同类型的值，可以用到后面的 any 关键字。</p>
<p>当然如果是支持泛型约束的函数，也可以用 some 关键字修饰，比如下面的代码就是合法的，这是因为泛型函数本身的类型通过泛型参数 T 是可以唯一确定的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeCollection</span>&lt;T&gt;<span class="params">()</span></span> -&gt; some <span class="type">Collection</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="type">T</span>]()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="any-关键字"><a href="#any-关键字" class="headerlink" title="any 关键字"></a>any 关键字</h1><p>any 关键字是 Swift 5.6 引入的，any 修饰的协议类型称为存在类型，也叫做盒子类型，它表达的意思是某个对象具体的类型需要在运行时阶段确定，编译期只能模糊确定它遵循某种协议，像是一个盒子，盒子里可以装任意符合条件的具体类型，也就是”存在类型”的含义。</p>
<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/0932cb8cf7174473a0bf26361335c9df~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp?" alt=""></p>
<p>但存在类型由于需要在运行时阶段才能确定具体类型和内存分布，因此编译器无法针对存在类型做更多有效的优化，比如泛型特化(Specialization)，以及方法调用时只能采用动态派发而不是直接静态派发的方式，所以性能上会有损耗。Swift 为了让开发者意识到使用存在类型存在的这种性能损耗，所以强制让开发者在使用存在类型时加上关键字，换句话说，any 的存在并没有在编译层面起到太多作用，更多是为了提醒开发者。</p>
<p>这种存在类型的使用是很常见，例如下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Food</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: Food)</span></span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Country</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">meet</span><span class="params">(<span class="number">_</span> person: Person)</span></span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Unit</span>: <span class="title">Equatable</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compare</span><span class="params">(<span class="number">_</span> a: Unit, <span class="number">_</span> b: Unit)</span></span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>其中，meet 和 compare 函数在 Swift 5.7 都会报错</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Use of protocol 'Person' as a type must be written 'any Person'</span><br><span class="line"></span><br><span class="line">Use of protocol 'Unit' as a type must be written 'any Unit'</span><br></pre></td></tr></table></figure>

<p>而 eat 函数虽然也用到了存在类型，但是 Swift 团队计划在 Swift 6 再提示编译错误。</p>
<p>any 确实可以去除上述编译报错，但是 Swift 团队的本意其实是希望尽可能少使用 any ，或者说尽可能少使用存在类型，转而用泛型和具体类型实现相同的逻辑。</p>
<p>我们可以将前面的代码改写为下述代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Food</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">(<span class="number">_</span> food: some Food)</span></span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">associatedtype</span> <span class="type">Country</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">meet</span><span class="params">(<span class="number">_</span> person: some Person)</span></span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Unit</span>: <span class="title">Equatable</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">compare</span>&lt;U: Unit&gt;<span class="params">(<span class="number">_</span> a: U, <span class="number">_</span> b: U)</span></span> &#123; &#125;</span><br></pre></td></tr></table></figure>

<p>这会让我们的代码语义更明确，同时在编译阶段也能确定函数接受的具体类型参数。</p>
<p>事实上，大部分场景下，any 关键字都可以用泛型、具体类型、不透明类型来代替，功能上没有什么区别，而性能上优于存在类型，目前可以想到的只能用 any 关键字的地方，是某些需要返回不同类型的场景，例如下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">makeFood</span><span class="params">()</span></span> -&gt; any <span class="type">Food</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ... &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Meat</span>()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="type">Vegetable</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><ul>
<li><a href="https://www.avanderlee.com/swift/some-opaque-types/" target="_blank" rel="noopener">Some keyword in Swift: Opaque types explained with code examples</a></li>
<li><a href="https://swiftsenpai.com/swift/understanding-some-and-any/" target="_blank" rel="noopener">Understanding the “some” and “any” keywords in Swift 5.7 - Swift Senpai</a></li>
<li><a href="https://juejin.cn/post/7119062263406788616" target="_blank" rel="noopener">【译】Understanding the “some” and “any” keywords in Swift 5.7 - 掘金</a></li>
<li><a href="https://www.donnywals.com/what-is-the-some-keyword-in-swift/" target="_blank" rel="noopener">What is the “some” keyword in Swift? – Donny Wals</a></li>
<li><a href="https://www.donnywals.com/what-is-the-any-keyword-in-swift/" target="_blank" rel="noopener">What is the “any” keyword in Swift? – Donny Wals</a></li>
<li><a href="https://juejin.cn/post/7116463990724624421" target="_blank" rel="noopener">【译】What is the “any” keyword in Swift? - 掘金</a></li>
<li><a href="https://www.donnywals.com/what-are-primary-associated-types-in-swift-5-7/" target="_blank" rel="noopener">What are primary associated types in Swift 5.7? – Donny Wals</a></li>
<li><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0346-light-weight-same-type-syntax.md" target="_blank" rel="noopener">swift-evolution/0346-light-weight-same-type-syntax.md at main · apple/swift-evolution · GitHub</a></li>
<li><a href="https://juejin.cn/post/6993316954916257822" target="_blank" rel="noopener">【Swift-不透明类型】从SwiftUI看some关键字 - 掘金</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2023/04/24/iOS%E5%BC%80%E5%8F%91/Swift%20%E5%B9%B6%E5%8F%91%E4%B8%AD%20Task%20%E9%9A%90%E5%BC%8F%E6%8D%95%E8%8E%B7%20self%20%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/24/iOS%E5%BC%80%E5%8F%91/Swift%20%E5%B9%B6%E5%8F%91%E4%B8%AD%20Task%20%E9%9A%90%E5%BC%8F%E6%8D%95%E8%8E%B7%20self%20%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">iOS开发/Swift 并发中 Task 隐式捕获 self 的问题</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-24 10:20:46" itemprop="dateCreated datePublished" datetime="2023-04-24T10:20:46+08:00">2023-04-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <hr>
<p>title: Swift 并发中 Task 隐式捕获 self 的问题<br>date: 2023-04-24<br>category: iOS开发<br>description: “Task 会隐式捕获 self 但没有编译提示，在大部分场景下这种特性并没有问题，但是遇到无限异步序列时容易造成循环引用问题”<br>tags:  [Swift, Swift 并发]</p>
<hr>
<h1 id="隐式捕获"><a href="#隐式捕获" class="headerlink" title="隐式捕获"></a>隐式捕获</h1><p>Swift Concurrency 的 Task 有两个常用的初始化方法</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">init</span>(priority: <span class="type">TaskPriority?</span> = <span class="literal">nil</span>, operation: @escaping @<span class="type">Sendable</span> () async -&gt; <span class="type">Success</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">detached</span><span class="params">(priority: TaskPriority? = <span class="literal">nil</span>, operation: @escaping @Sendable <span class="params">()</span></span></span> async -&gt; <span class="type">Success</span>) -&gt; <span class="type">Task</span>&lt;<span class="type">Success</span>, <span class="type">Failure</span>&gt;</span><br></pre></td></tr></table></figure>

<p>可以看到，两个方法的 <code>operation</code> 参数都是用 @escaping 修饰的，意味着 operation 是一个逃逸闭包，逃逸闭包会在声明后延长生命周期再执行，因此如果在一个类当中使用 Task，Task 内部又调用了类的方法，就会造成对 self 的隐式捕获。</p>
<p>这种 self 的隐式捕获是一个很常见的问题，例如下面的代码</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            handle()</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们用到了 GCD 调用 handle 方法，如果直接这样写就会触发 Xcode 的编译错误</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Call to method 'handle' in closure requires explicit use of 'self' to make capture semantics explicit</span><br></pre></td></tr></table></figure>

<p>这是因为 Xcode 希望开发者通过显式调用 self.handle 的方式，提醒开发者这里发生了隐式捕获。需要注意的是，隐式捕获并不一定会造成内存泄漏，例如在这里，隐式捕获仅仅会因为捕获 self，导致 self 的生命周期延长到了下一个 runloop，一旦 GCD 执行结束，self 就可以正常释放，所以这里可以简单改为</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">self</span>.handle()</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是在 Task 这里，情况有些不同，对于下面的代码，Xcode 是不会有任何提示的。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Task</span> &#123;</span><br><span class="line">            handle()</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这是因为前面提到的 Task 的两个初始化方法，在源码内部实际上会用 <code>_implicitSelfCapture</code> 关键词修饰 operation，<code>_implicitSelfCapture</code> 关键词可以让被修饰的 block 捕获 self 而不会触发显式捕获的错误，因为 <a href="https://github.com/apple/swift-evolution/blob/main/proposals/0304-structured-concurrency.md#implicit-self" target="_blank" rel="noopener">Swift Concurrency 的设计者认为</a>，显式捕获 self 的意图是为了发现隐藏的循环引用，而 Task 的闭包会被 <strong>立即执行</strong>，所以看起来并不需要传递这种意图。</p>
<blockquote>
<p>The intent behind requiring self. when capturing self in an escaping closure is to warn the developer about potential reference cycles. The closure passed to Task is executed immediately, and the only reference to self is what occurs in the body. Therefore, the explicit self. isn’t communicating useful information and should not be required.  </p>
</blockquote>
<h1 id="隐式捕获的问题"><a href="#隐式捕获的问题" class="headerlink" title="隐式捕获的问题"></a>隐式捕获的问题</h1><p>看起来确实是这样，Task 通常情况下，包括在前面提到的场景下，都是会立即执行并结束的，它最多可能只会延长 self 的生命周期，并不会发生循环引用。</p>
<p>但在一些特殊情况下，这种预想就失效了，比如如果遇到了无限的异步序列 (AsyncSequence)。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Task</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">            <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">                <span class="built_in">print</span>(notification)</span><br><span class="line">                handle()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里 Task 内部的 operation 监听了应用进入后台的通知，并通过 for await 对  notifications 异步序列进行了监听，也没有增加监听停止的条件，这样的代码就会造成 self 无法被释放。进一步分析会发现，这里真正捕获 self 的并不是 <strong>最外层的 Task</strong>，之所以这样说是因为如果我们将代码改为下面的形式，内存泄漏依然存在。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Task</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            await <span class="keyword">self</span>?.observeAppEnterBackground()</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">observeAppEnterBackground</span><span class="params">()</span></span> async &#123;</span><br><span class="line">        <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">        <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">            <span class="built_in">print</span>(notification)</span><br><span class="line">            handle()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，在初始化 Task 时，我们通过捕获列表已经将 self 弱引用捕获了，但是执行代码后， TestView 仍然无法释放。</p>
<p>实际上真正引发泄漏的是下面的代码，我们通过 for await 遍历无限异步序列 notifications，相当于代码陷入了死循环，而每一次 await 操作又会隐式捕获 self，造成了 self 无法被释放，可以简单认为，每一次 await 操作都会隐式生成一个新的 Task，而新的 Task 又会捕获 self，这才是造成循环引用的原因。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">    <span class="built_in">print</span>(notification)</span><br><span class="line">    handle()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h1><h2 id="弱捕获-self"><a href="#弱捕获-self" class="headerlink" title="弱捕获 self"></a>弱捕获 self</h2><p>既然明确了在监听无限序列时因为捕获 self 导致了循环引用，解决思路也就有了，最传统的方式就是类似 GCD 和闭包引用一样，我们通过捕获列表将 self 引用变为弱引用，从而避免 Task 持有 self。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="type">Task</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">            <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                <span class="built_in">print</span>(notification)</span><br><span class="line">                <span class="keyword">self</span>.handle()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是，由于真正发生捕获行为的地方是在 for await 的地方，因此如果像下面这样弱引用 self，是不能解决内存泄漏问题。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Task</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">    <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">    <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">        <span class="built_in">print</span>(notification)</span><br><span class="line">        <span class="keyword">self</span>.handle()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>虽然通过 weakself 捕获， TestView 此时确实可以正常释放了，但是 Task 本身其实是脱离 TestView 的生命周期存在的，所以代码对 notifications 的监听并没有停止，验证这一点也很简单，我们将打印语句移动一下，就会发现即使 TestView 释放了，打印语句仍然会被执行。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Task</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">    <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">        <span class="built_in">print</span>(notification)</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">        <span class="keyword">self</span>.handle()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此正确的思路应该是取消 Task 执行。</p>
<h2 id="取消-Task"><a href="#取消-Task" class="headerlink" title="取消 Task"></a>取消 Task</h2><p>实际上 Swift Concurrency 并不推荐我们直接初始化一个 Task，因为这样初始化的 Task 是一个独立的根 Task，没有所属的父 Task，也就意味着 Task 的生命周期是独立存在的。Swift Concurrency 建议所有的 Task 都应该形成一个任务树，从而实现结构化编程。</p>
<blockquote>
<p>结构化编程：并发操作保证控制流路径的单一入口和单一出口  </p>
</blockquote>
<p>所以最合理的方式是这样修复。</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> task: <span class="type">Task</span>&lt;<span class="type">Void</span>, <span class="type">Never</span>&gt;?</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">deinit</span> &#123;</span><br><span class="line">        task?.cancel()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">"deinit"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span> &#123;</span><br><span class="line">        task = <span class="type">Task</span> &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> notifications = <span class="type">NotificationCenter</span>.<span class="keyword">default</span>.notifications(named: <span class="type">UIApplication</span>.didEnterBackgroundNotification)</span><br><span class="line">            <span class="keyword">for</span> await notification <span class="keyword">in</span> notifications &#123;</span><br><span class="line">                <span class="keyword">guard</span> <span class="keyword">let</span> <span class="keyword">self</span> = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> &#125;</span><br><span class="line">                <span class="built_in">print</span>(notification)</span><br><span class="line">                <span class="keyword">self</span>.handle()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，当 TestView 被释放时，对 UIApplication.didEnterBackgroundNotification 的监听也能正常取消。</p>
<h1 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h1><ul>
<li><a href="https://forums.swift.org/t/why-task-doesnt-need-explicit-use-of-self/58748/6" target="_blank" rel="noopener">Why Task { } doesn’t need explicit use of self? - #6 by AlexSedykh - Using Swift - Swift Forums</a></li>
<li><a href="https://github.com/apple/swift-evolution/blob/main/proposals/0304-structured-concurrency.md#implicit-self" target="_blank" rel="noopener">swift-evolution/0304-structured-concurrency.md at main · apple/swift-evolution · GitHub</a></li>
<li><a href="https://forums.swift.org/t/explicit-self-not-required-for-task-closures/54364/19" target="_blank" rel="noopener">Explicit self not required for Task closures? - #19 by kevinc - Using Swift - Swift Forums</a></li>
<li><a href="https://developer.apple.com/forums/thread/691814" target="_blank" rel="noopener">Swift 5.5 Task { … } weak self | Apple Developer Forums</a></li>
<li><a href="https://www.swiftwithvincent.com/blog/three-mistakes-to-avoid-with-async-await-in-swift" target="_blank" rel="noopener">3 mistakes to avoid with async / await — Swift with Vincent</a></li>
<li><a href="https://www.swiftbysundell.com/articles/memory-management-when-using-async-await/" target="_blank" rel="noopener">Memory management when using async/await in Swift | Swift by Sundell</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/28/%E9%9A%8F%E7%AC%94/%E5%85%B3%E4%BA%8E%E7%BE%8E%E7%9A%84%E6%9C%AC%E8%83%BD%E2%80%94%E2%80%94%E3%80%8A%E4%B9%94%E5%B8%83%E6%96%AF%E4%BC%A0%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/28/%E9%9A%8F%E7%AC%94/%E5%85%B3%E4%BA%8E%E7%BE%8E%E7%9A%84%E6%9C%AC%E8%83%BD%E2%80%94%E2%80%94%E3%80%8A%E4%B9%94%E5%B8%83%E6%96%AF%E4%BC%A0%E3%80%8B/" class="post-title-link" itemprop="url">关于美的本能——《乔布斯传》</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-28 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-28T00:00:00+08:00">2020-03-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>至繁归于至简</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/28/%E9%9A%8F%E7%AC%94/%E5%85%B3%E4%BA%8E%E7%BE%8E%E7%9A%84%E6%9C%AC%E8%83%BD%E2%80%94%E2%80%94%E3%80%8A%E4%B9%94%E5%B8%83%E6%96%AF%E4%BC%A0%E3%80%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/13/%E9%9A%8F%E7%AC%94/%E4%BB%80%E4%B9%88%E9%80%A0%E5%B0%B1%E4%BA%86%E6%96%87%E6%98%8E%E2%80%94%E2%80%94%E3%80%8A%E6%9E%AA%E7%82%AE%E3%80%81%E7%97%85%E8%8F%8C%E4%B8%8E%E9%92%A2%E9%93%81%EF%BC%9A%E4%BA%BA%E7%B1%BB%E7%A4%BE%E4%BC%9A%E7%9A%84%E5%91%BD%E8%BF%90%E3%80%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/13/%E9%9A%8F%E7%AC%94/%E4%BB%80%E4%B9%88%E9%80%A0%E5%B0%B1%E4%BA%86%E6%96%87%E6%98%8E%E2%80%94%E2%80%94%E3%80%8A%E6%9E%AA%E7%82%AE%E3%80%81%E7%97%85%E8%8F%8C%E4%B8%8E%E9%92%A2%E9%93%81%EF%BC%9A%E4%BA%BA%E7%B1%BB%E7%A4%BE%E4%BC%9A%E7%9A%84%E5%91%BD%E8%BF%90%E3%80%8B/" class="post-title-link" itemprop="url">什么造就了文明——《枪炮、病菌与钢铁：人类社会的命运》</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-13 00:00:00" itemprop="dateCreated datePublished" datetime="2020-03-13T00:00:00+08:00">2020-03-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%9A%8F%E7%AC%94/" itemprop="url" rel="index">
                    <span itemprop="name">随笔</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>是什么造就了丰富多彩的文明？是枪炮、病菌、钢铁？是优良的生理特性？是与生俱来的高贵血统？</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2020/03/13/%E9%9A%8F%E7%AC%94/%E4%BB%80%E4%B9%88%E9%80%A0%E5%B0%B1%E4%BA%86%E6%96%87%E6%98%8E%E2%80%94%E2%80%94%E3%80%8A%E6%9E%AA%E7%82%AE%E3%80%81%E7%97%85%E8%8F%8C%E4%B8%8E%E9%92%A2%E9%93%81%EF%BC%9A%E4%BA%BA%E7%B1%BB%E7%A4%BE%E4%BC%9A%E7%9A%84%E5%91%BD%E8%BF%90%E3%80%8B/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/08/iOS%E5%BC%80%E5%8F%91/WKWebView%E7%9A%84TSL%E5%AE%89%E5%85%A8%E6%80%A7%E6%A0%A1%E9%AA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/08/iOS%E5%BC%80%E5%8F%91/WKWebView%E7%9A%84TSL%E5%AE%89%E5%85%A8%E6%80%A7%E6%A0%A1%E9%AA%8C/" class="post-title-link" itemprop="url">WKWebView的TSL安全性校验</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-08 00:00:00" itemprop="dateCreated datePublished" datetime="2019-07-08T00:00:00+08:00">2019-07-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>WKWebView 允许 native 介入到 HTTP 的验证流程，类似于 URLSession 一样对 Challenge 进行校验，具体代码如下</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/07/08/iOS%E5%BC%80%E5%8F%91/WKWebView%E7%9A%84TSL%E5%AE%89%E5%85%A8%E6%80%A7%E6%A0%A1%E9%AA%8C/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/20/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%BA%8C%EF%BC%89AFNetworking%E5%AF%B9form-data%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/20/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%BA%8C%EF%BC%89AFNetworking%E5%AF%B9form-data%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">AFNetworking（二）AFNetworking对form-data请求体的处理</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-20 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-20T00:00:00+08:00">2019-01-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">AFNetworking源码解析</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>AFNetworking 发送 GET、POST 等请求时可以直接将参数按照字典结构传入，最终编码到 url 中或者是 body 实体中，同时也支持按照 multipart/form-data 格式，将多种不同的数据合入到 body 中进行发送，而这些就涉及到 AFNetworking 的请求序列化类，也就是 AFURLRequestSerialization。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/20/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%BA%8C%EF%BC%89AFNetworking%E5%AF%B9form-data%E8%AF%B7%E6%B1%82%E4%BD%93%E7%9A%84%E5%A4%84%E7%90%86/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/18/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%B8%80%EF%BC%89%E4%BB%8E%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E4%BA%86%E8%A7%A3AFHTTPSessionManager/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/18/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%B8%80%EF%BC%89%E4%BB%8E%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E4%BA%86%E8%A7%A3AFHTTPSessionManager/" class="post-title-link" itemprop="url">AFNetworking（一）从一次请求了解AFHTTPSessionManager</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-18 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-18T00:00:00+08:00">2019-01-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/" itemprop="url" rel="index">
                    <span itemprop="name">AFNetworking源码解析</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>AFNetworking 的核心类是 AFHTTPSessionManager，负责各种 HTTP 请求的发起和处理，它继承自 AFURLSessionManager，是各种请求的直接执行者。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/18/AFNetworking%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/AFNetworking%EF%BC%88%E4%B8%80%EF%BC%89%E4%BB%8E%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E4%BA%86%E8%A7%A3AFHTTPSessionManager/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/02/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E7%9A%84Base64%E7%BC%96%E7%A0%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/02/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E7%9A%84Base64%E7%BC%96%E7%A0%81/" class="post-title-link" itemprop="url">iOS中的Base64编码</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-02 00:00:00" itemprop="dateCreated datePublished" datetime="2019-01-02T00:00:00+08:00">2019-01-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Base64 是一种基于 64 个可打印字符来表示二进制数据编码方式，广泛运用在处理文本数据的场合，表示、传输、存储一些二进制数据，包括 MIME 的电子邮件及 XML 的一些复杂数据。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/01/02/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E7%9A%84Base64%E7%BC%96%E7%A0%81/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/23/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86CYMK%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E7%9A%84%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/23/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86CYMK%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E7%9A%84%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">iOS中错误处理CYMK颜色空间的问题</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-23 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-23T00:00:00+08:00">2018-10-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天在处理一张图片时图片处理后变成了纯黑色图片，其中定位到处理图片时进行了 CGContext 绘制操作，初始化 context 的代码如下所示：</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/10/23/iOS%E5%BC%80%E5%8F%91/iOS%E4%B8%AD%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86CYMK%E9%A2%9C%E8%89%B2%E7%A9%BA%E9%97%B4%E7%9A%84%E9%97%AE%E9%A2%98/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/12/iOS%E5%BC%80%E5%8F%91/iOS%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%BC%B9%E8%B5%B7%E6%97%B6tableview%E7%AC%AC%E4%B8%80%E5%93%8D%E5%BA%94%E8%80%85cell%E4%B8%8D%E8%A2%AB%E9%81%AE%E6%8C%A1%E7%9A%84%E6%95%88%E6%9E%9C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="Yasic Yu">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yasic Yu">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/12/iOS%E5%BC%80%E5%8F%91/iOS%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%BC%B9%E8%B5%B7%E6%97%B6tableview%E7%AC%AC%E4%B8%80%E5%93%8D%E5%BA%94%E8%80%85cell%E4%B8%8D%E8%A2%AB%E9%81%AE%E6%8C%A1%E7%9A%84%E6%95%88%E6%9E%9C/" class="post-title-link" itemprop="url">iOS实现键盘弹起时tableview第一响应者cell不被遮挡的效果</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-10-12 00:00:00" itemprop="dateCreated datePublished" datetime="2018-10-12T00:00:00+08:00">2018-10-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/iOS%E5%BC%80%E5%8F%91/" itemprop="url" rel="index">
                    <span itemprop="name">iOS开发</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近期在调研 XLForm 框架，一个集成多种表单常见功能的框架，其中对于 UITableView 中的输入框与键盘弹出隐藏逻辑进行了相关处理以避免输入区域被遮挡。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2018/10/12/iOS%E5%BC%80%E5%8F%91/iOS%E5%AE%9E%E7%8E%B0%E9%94%AE%E7%9B%98%E5%BC%B9%E8%B5%B7%E6%97%B6tableview%E7%AC%AC%E4%B8%80%E5%93%8D%E5%BA%94%E8%80%85cell%E4%B8%8D%E8%A2%AB%E9%81%AE%E6%8C%A1%E7%9A%84%E6%95%88%E6%9E%9C/">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Yasic Yu"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">Yasic Yu</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">50</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Yasic" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Yasic" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:yuxuan2580@gmail.com" title="E-Mail → mailto:yuxuan2580@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yasic Yu</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
